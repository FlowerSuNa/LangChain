# Chat History

- 채팅봇의 핵심 기능은 이전 대화 내용을 문맥으로 활용하는 것으로, 이를 통해 자연스러운 대화 흐름을 유지할 수 있음
- 가장 기본적인 방식은 이전 메시지들을 모델의 프롬프트에 직접 포함시키는 것이지만, 오래된 메시지는 적절히 제거하여 모델이 처리해야 할 정보량을 조절할 수 있음
- 장시간 진행되는 대화의 경우, 단순히 이전 메시지를 저장하는 것을 넘어 대화 내용을 요약하여 저장하는 등의 고급 메모리 관리 기법을 활용할 수 있음
- 이러한 대화 이력 관리를 위한 메모리 컴포넌트를 LangChain으로 구현할 수 있음

**채팅 히스토리 관리**




## MessagePlaceholder

- LangChain에서 가장 기본적인 메모리 구현 방법인 **Message Passing** 방식으로, 이전 대화 기록을 체인에 직접 전달하여 문맥을 유지하는 방식임
- `SystemMessage`(시스템 지시사항), `HumanMessage`(사용자 입력), `AIMessage`(AI 응답) 등 다양한 유형의 메시지를 `ChatPromptTemplate`를 통해 구조화하며,  `MessagePlaceholder`를 사용하여 이전 대화 내용을 포함시킴
- 챗봇의 기본적인 메모리 시스템을 구현하는데 사용되며, 이를 통해 AI는 이전 대화 맥락을 이해하고 그에 맞는 적절한 응답을 생성할 수 있음

## RunnableWithMessageHistory

- LangChain에서 대화 기록을 관리하는 고급 기능으로, 체인의 실행 과정에서 메시지 기록을 자동으로 저장하고 검색할 수 있게 해주는 래퍼(wrapper) 클래스임
- 이 기능은 대화 세션별로 독립적인 기록을 유지할 수 있도록 하며, `ConfigurableField`를 통해 메모리 구성을 유연하게 조정할 수 있음
- 특히, 여러 사용자와 동시에 대화할 때 각 세션의 컨텍스트를 분리하여 관리하는 데 매우 유용함
- 주요 장점은 대화 기록 관리의 자동화와 일관성 있는 메시지 처리이지만, 메모리 저장소 설정과 관리에 추가적인 구성이 필요하다는 점을 고려해야 함
- 또한 Redis나 다른 외부 저장소와 통합하여 영구적인 대화 기록 보관도 가능함
- 구현 시에는 `get_session_history` 콜백을 통해 세션 ID별로 메시지 기록을 관리하며, 각 대화의 컨텍스트를 정확하게 유지할 수 있음

--

# Store

## In Memory

- 메모리 기반 로컬 저장소로 활용할 수 있는 클래스로, 대화 이력의 기본 구조를 제공함
- `BaseChatMesseageHistory`와 `BaseModel`을 상속받아 메시지를 메모리에서 효율적으로 관리함
- 특히 message 리스트를 통해 `BaseMessage` 객체들을 순차적으로 저장하고, `add_message`와 `clear` 메서드로 히스토리를 유연하게 관리할 수 있음

- 시스템의 핵심임 `store` 변수는 전역 딕셔너리로 구현되어 세션별 대화 이력을 구분하여 저장함
- `session_id`를 키로 사용하여 각 세션의 `InMemoryHistory` 객체에 빠르게 접근할 수 있으며, 다중 사용자 환경에서도 효율적인 대화 관리가 가능함

- `get_session_history` 함수는 세션 관리의 진입점 역할을 하며, 존재하지 않는 세션에 대해 자동으로 `InMemoryHistory` 객체를 생성하는 팩토리 패턴을 구현함
- 이러한 구조를 통해 세션의 생명주기를 자동으로 관리하고 메모리 효율성을 높일 수 있음

## SQLite

- 간단 설명
**구현 시 유의할 점**
- SQLite 통합 구현을 위해서는 먼저 메시지를 저장할 데이터베이스 테이블 구조를 정의하고, `BaseChatMessageHistory`를 상속받아 메시지 저장/조회 로직을 구현해야 함
- 이때 session ID를 기준으로 대화 내용을 구분하여 관리해야 함
- 메시지의 타입(Human, AI), 내용, 메타데이터, 타임스탬프 등의 정보를 체계적으로 저장하고, 필요할 때 효율적으로 검색하고 활용할 수 있도록 적절한 인덱싱 전략을 수립하는 것이 중요함


---
- `trim_message` 함수는 컨텍스트로 윈도우의 토큰 제한을 관리하기 위한 핵심 도구로, 시스템 메시지를 포함할지 여부와 어디서부터 트리밍을 시작할지 등을 상세하게 설정할 수 있음
- 트리밍 전략으로 last 옵션을 사용하면 가장 최근의 메시지부터 시작하여 지정된 토큰 제한에 맞춰 이전 메시지들을 선택적으로 포함시킬 수 있음
